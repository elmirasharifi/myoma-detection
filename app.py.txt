import os
import torch
import torch.nn as nn
from torchvision import models, transforms
import gradio as gr

# Û±. Ø¢Ø¯Ø±Ø³ Ø±Ø§ Ø¨Ù‡ Ù…Ø³ÛŒØ± ÙØ¹Ù„ÛŒ ØªØºÛŒÛŒØ± Ø¯Ø§Ø¯ÛŒÙ… (Ú†ÙˆÙ† Ø¯Ø± Ú¯ÛŒØªâ€ŒÙ‡Ø§Ø¨ Ù‡Ù…Ù‡ Ú©Ù†Ø§Ø± Ù‡Ù… Ù‡Ø³ØªÙ†Ø¯)
base_path = "./" 

# Û². ØªØ¹Ø±ÛŒÙ Ù…Ø¹Ù…Ø§Ø±ÛŒ Ù…Ø¯Ù„â€ŒÙ‡Ø§
def get_model(model_name):
    if model_name == "resnext":
        model = models.resnext50_32x4d(weights=None)
        model.fc = nn.Linear(model.fc.in_features, 2)
    elif model_name == "vgg":
        model = models.vgg16(weights=None)
        model.classifier[6] = nn.Linear(model.classifier[6].in_features, 2)
    elif model_name == "densenet":
        model = models.densenet121(weights=None)
        model.classifier = nn.Linear(model.classifier.in_features, 2)
    return model

# Û³. Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù…Ø¯Ù„â€ŒÙ‡Ø§ Ø§Ø² Ú©Ù†Ø§Ø± ÙØ§ÛŒÙ„ Ø§ØµÙ„ÛŒ
device = torch.device("cuda" if torch.cuda.is_available() else "cpu")
model_files = {
    "ResNeXt50": "ResNeXt50_Myoma_Detector_V4_Best.pth",
    "VGG16": "VGG16_Myoma_Detector_V4_Best.pth",
    "DenseNet121": "DenseNet121_Myoma_Detector_V4_Best.pth"
}

loaded_models = {}
for name, filename in model_files.items():
    full_path = os.path.join(base_path, filename)
    if os.path.exists(full_path):
        m_type = "resnext" if "ResNeXt" in name else "vgg" if "VGG" in name else "densenet"
        m = get_model(m_type)
        m.load_state_dict(torch.load(full_path, map_location=device))
        m.to(device).eval()
        loaded_models[name] = m
    else:
        print(f"Error: {filename} not found!")

# Û´. Ù¾ÛŒØ´â€ŒÙ¾Ø±Ø¯Ø§Ø²Ø´
transform = transforms.Compose([
    transforms.Resize((224, 224)),
    transforms.ToTensor(),
    transforms.Normalize([0.485, 0.456, 0.406], [0.229, 0.224, 0.225])
])

def predict_combined(img):
    if not loaded_models: return "Ù…Ø¯Ù„â€ŒÙ‡Ø§ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù†Ø´Ø¯Ù‡â€ŒØ§Ù†Ø¯", {}
    img_t = transform(img).unsqueeze(0).to(device)
    results = {}
    with torch.no_grad():
        for name, m in loaded_models.items():
            out = m(img_t)
            prob = torch.nn.functional.softmax(out[0], dim=0)
            results[name] = float(prob[1])

    avg_score = sum(results.values()) / len(results)
    final_diagnosis = "Myoma (Ø¨ÛŒÙ…Ø§Ø±)" if avg_score > 0.5 else "Normal (Ø³Ø§Ù„Ù…)"
    return final_diagnosis, results

# Ûµ. Ø±Ø§Ø¨Ø· Ú©Ø§Ø±Ø¨Ø±ÛŒ
with gr.Blocks() as demo:
    gr.Markdown("# ğŸ¥ Ø³Ø§Ù…Ø§Ù†Ù‡ ØªØ´Ø®ÛŒØµ Ù‡ÙˆØ´Ù…Ù†Ø¯ Ù…ÛŒÙˆÙ… Ø±Ø­Ù…")
    with gr.Row():
        img_input = gr.Image(type="pil")
        with gr.Column():
            res_text = gr.Textbox(label="ØªØ´Ø®ÛŒØµ Ù†Ù‡Ø§ÛŒÛŒ")
            res_labels = gr.Label(label="Ø§Ø­ØªÙ…Ø§Ù„ ÙˆØ¬ÙˆØ¯ Ù…ÛŒÙˆÙ…")
    btn = gr.Button("ØªØ­Ù„ÛŒÙ„ ØªØµÙˆÛŒØ±", variant="primary")
    btn.click(predict_combined, img_input, [res_text, res_labels])

if __name__ == "__main__":
    demo.launch()
